#!/usr/bin/env bash
# .sh/bin/chpw 20190603 - 20190828
# Copyright (C) 1995-2019 Mark Constable <markc@renta.net> (AGPL-3.0)

[[ -z $2 || $1 =~ '-h' ]] && echo "Usage: chpw user@domain pw" && exit 1

[[ $(id -u) -gt 0 ]] && echo "ERROR: must be root (use sudo -i)" && exit 2

source /root/.vhosts/$(hostname -f) || exit 3 # only needed for SQCMD

EMAIL=${1,,} # lowercase user@domain
shift
NEWPW=$@
CRYPT=$(doveadm pw -s SHA512-CRYPT -p "$NEWPW")
VHOST=${EMAIL#*@} # userid @ $VHOST
VCONF="/root/.vhosts/$VHOST.conf"

ISUSR=$(cat "SELECT id FROM vmails WHERE user='$EMAIL'" | $SQCMD)

if [[ -z $ISUSR ]]; then
    echo "ERROR: '$EMAIL' does not exist in vmails"
    exit 3
fi

cat "UPDATE vmails SET password='$CRYPT' WHERE user='$EMAIL'" | $SQCMD

if [[ -f $VCONF ]]; then
    grep -q $EMAIL $VCONF
    if [[ $? -eq 0 ]]; then
        echo "Old Password"
        grep -A1 "^Username: $EMAIL" $VCONF
        sed -i "/^Username: $EMAIL/{n;s/.*/Password: $NEWPW/}" $VCONF
    else
        cat << EOS | tee -a $VCONF
Mail
=========

Username: $EMAIL
Password: $NEWPW

EOS
    fi
    echo
    echo "New Password"
    grep -A1 "^Username: $EMAIL" $VCONF
else
    echo "ERROR: $VCONF does not exist"
fi

systemd-cat -t hlog echo "$(whoami) $(basename $0) $*"
