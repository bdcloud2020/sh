#!/usr/bin/env bash
# .sh/bin/shnewpw 20190114 - 20190114
# Copyright (C) 1995-2019 Mark Constable <markc@renta.net> (AGPL-3.0)

[[ $1 =~ -h ]] && echo "Usage: shnewpw [password] [vhost]" && exit 1

VPASS=${1:-$(pwgen -sB 16 1)}
VHOST=${2:-$(hostname -f)}

if [[ -f ~/.vhosts/$VHOST ]];then
    source ~/.vhosts/$VHOST
    PWPIN=$((1000 + RANDOM % 9999))
    NEWPW=$(pwgen -sB 16 1)

    if [[ -d $WPATH ]]; then
        echo $VPASS > $WPATH/$PWPIN.txt
        chown $UUSER:www-data $WPATH/$PWPIN.txt
        chmod 640 $WPATH/$PWPIN.txt
        echo "$VPASS @ https://$VHOST/$PWPIN.txt"
    else
        echo "ERROR: $WPATH does not exist"
    fi
else
    echo "ERROR: ~/.vhosts/$VHOST does not exist"
fi

systemd-cat -t hlog echo "$(whoami) $(basename $0) $*"
