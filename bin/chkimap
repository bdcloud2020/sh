#!/usr/bin/env bash
# .sh/bin/chkimap 20190601 - 20190601
# Copyright (C) 1995-2019 Mark Constable <markc@renta.net> (AGPL-3.0)

[[ $1 =~ '-h' ]] && echo "Usage: chkimap" && exit 1

[[ $(id -u) -gt 0 ]] && echo "ERROR: must be root (use sudo -i)" && exit 2

CIMAP=/etc/dovecot

if [[ ! -d $CIMAP/vhosts ]]; then
    echo "^^^ Create $CIMAP/vhosts"
    mkdir $CIMAP/vhosts
fi

if [[ ! -d $CIMAP/sieve ]]; then
    echo "^^^ Create $CIMAP/sieve"
    mkdir $CIMAP/sieve
fi

if [[ ! -d $CIMAP/sieve/spamprobe ]]; then
    echo "^^^ Create $CIMAP/sieve/spamprobe symlink"
    cd $CIMAP/sieve
    ln -s /usr/bin/spamprobe $CIMAP/sieve/spamprobe
fi

if [[ ! -f $CIMAP/sieve/retrain-as-good.sieve ]]; then
    echo "*** Create $CIMAP/sieve/retrain-as-good.sieve"
    cat << 'EOS' > $CIMAP/sieve/retrain-as-good.sieve
require ["vnd.dovecot.execute", "environment", "variables", "imapsieve"];
if environment :matches "imap.mailbox" "*" {if string "${1}" "Trash" { stop; }}
execute :pipe "spamprobe" ["-c", "-d", ".spamprobe", "good"];
EOS
fi

if [[ ! -f $CIMAP/sieve/retrain-as-spam.sieve ]]; then
    echo "*** Create $CIMAP/sieve/retrain-as-spam.sieve"
    cat << 'EOS' > $CIMAP/sieve/retrain-as-spam.sieve
require ["vnd.dovecot.execute"];
execute :pipe "spamprobe" ["-c", "-d", ".spamprobe", "spam"];
EOS
fi

if [[ ! -f $CIMAP/sieve/global.sieve ]]; then
    echo "*** Create $CIMAP/sieve/global.sieve"
    cat << 'EOS' > $CIMAP/sieve/global.sieve
require ["vnd.dovecot.execute", "fileinto", "envelope", "variables", "editheader"];
if header :contains "from" ["root@", "daemon@", "postmaster@"] { fileinto "Trash";
} elsif header :contains "to" ["root@", "daemon@", "postmaster@"] { fileinto "Trash"; }
if envelope :localpart :matches "to" "*" { set "lhs" "${1}"; }
if envelope :domain :matches "to" "*" { set "rhs" "${1}"; }
execute :pipe :output "SCORE" "spamprobe" ["-c", "-d", "/home/u/${rhs}/home/${lhs}/.spamprobe", "receive"];
addheader :last "X-Spam" "${SCORE}";
if header :matches "X-Spam" "SPAM*" { fileinto "Junk"; }
EOS
fi
