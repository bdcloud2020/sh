#!/usr/bin/env bash
# .sh/bin/prepbkp 20190706 - 20190706
# Copyright (C) 1995-2019 Mark Constable <markc@renta.net> (AGPL-3.0)

[[ $1 =~ -h ]] && echo "Usage: prepbkp" && exit 1

[[ $(id -u) -gt 0 ]] && echo "ERROR: must be root (use sudo -i)" && exit 2

/usr/bin/mysql -BNe "show databases" | grep -v _schema | while read i; do \
 echo $i; \
 sleep 2; \
 mysqldump $i | gzip > /home/mysql/$i.sql.gz; done

/bin/ls -1d /home/u/*/home/*/.spamprobe | while read i; do \
 echo $i; \
 sleep 2; \
 HPATH=$(dirname $i); \
 cd $HPATH; \
 mkdir spamprobe-new; \
 cp -a .spamprobe spamprobe-bkp; \
 spamprobe -d spamprobe-bkp cleanup 2 14; \
 spamprobe -d spamprobe-bkp export | spamprobe -d spamprobe-new import; \
 chown $(stat -c "%u:%g" $HPATH) -R spamprobe-new; \
 mv .spamprobe spamprobe-old; \
 mv spamprobe-new .spamprobe; \
 rm -rf spamprobe-bkp spamprobe-old; done

systemd-cat -t hlog echo "$(whoami) $(basename $0) $*"
