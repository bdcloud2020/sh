#!/usr/bin/env bash
# .sh/bin/setup-all 20170519 - 20190629
# Copyright (C) 1995-2019 Mark Constable <markc@renta.net> (AGPL-3.0)

export PATH=/bin:/usr/bin:/sbin:/usr/sbin:/root/.sh/bin

[[ $1 =~ '-h' ]] && echo "Usage: setup-all [hostname.dom.ain] [(mysql)|sqlite] [distro($OSREL)] [mailto] [IP]" && exit 1

[[ $(id -u) -gt 0 ]] && echo "ERROR: must be root (use sudo -i)" && exit 2

echo "### Entering $0"

source /root/.shrc || exit 3

gethost
exit

VHOST=${1:-$(hostname -f|tr 'A-Z' 'a-z')}
HNAME=${VHOST%%.*} # hostname
HDOMN=${VHOST#*.*} # parent FQDN

DTYPE=${2:-$DTYPE}
OSREL=${3:-$OSREL}
MAIL2=${4:-"admin@$HDOMN"}
USEIP=${5:-''}

echo "### Entering setup-host for '$VHOST' with '$OSREL' and '$DTYPE'"
setup-host "mail.$VHOST" $DTYPE $OSREL $USEIP
echo "### Entering setup-deb"
setup-deb
echo "### Entering setup-db"
setup-db
echo "### Entering setup-etc"
setup-etc
echo "### Entering setup-hcp"
setup-hcp
echo "### Add parent dom.ain"
addvhost $HDOMN

source /root/.vhosts/$HDOMN

echo "### Send message to: $MAIL2"
cat ~/.vhosts/$HDOMN.conf ~/.vhosts/$VHOST.conf | mail -s "Setup $HDOMN - $(hostname -i)" -r $MAIL2 $MAIL2

systemd-cat -t hlog echo "$(whoami) $(basename $0) $*"
