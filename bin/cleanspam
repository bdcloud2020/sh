#!/usr/bin/env bash
# .sh/bin/cleanspam 20190706 - 20190720
# Copyright (C) 1995-2019 Mark Constable <markc@renta.net> (AGPL-3.0)

# TODO: add per mailbox option and use VPATH instead of /home/u

[[ $1 =~ -h ]] && echo "Usage: cleanspam" && exit 1

[[ $(id -u) -gt 0 ]] && echo "ERROR: must be root (use sudo -i)" && exit 2

find /home/u -type d -name .spamprobe | while read i; do \
 echo $i; \
 sleep 2; \
 HPATH=$(dirname $i); \
 cd $HPATH; \
 mkdir spamprobe-new; \
 cp -a .spamprobe spamprobe-bkp; \
 spamprobe -d spamprobe-bkp cleanup 2 14; \
 spamprobe -d spamprobe-bkp export | spamprobe -d spamprobe-new import; \
 chown $(stat -c "%u:%g" $HPATH) -R spamprobe-new; \
 mv .spamprobe spamprobe-old; \
 mv spamprobe-new .spamprobe; \
 rm -rf spamprobe-bkp spamprobe-old; done

systemd-cat -t hlog echo "$(whoami) $(basename $0) $*"
